<!DOCTYPE html>
<html>
  <head>
    <title>Bakery Feedback</title>
    <style>
      body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
      h1 { text-align: center; }
      
      /* --- Auth & User Section --- */
      #auth-container, #user-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
      }
      #auth-container input[type="email"] {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: calc(100% - 150px);
      }
      #auth-container button, #user-container button {
        padding: 10px 15px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
      }
      #send-link-btn {
        background-color: #007bff;
        color: white;
      }
      #send-link-btn:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }
      #sign-out-btn {
        background-color: #dc3545;
        color: white;
      }
      #user-container {
        display: none; /* Hidden by default */
        justify-content: space-between;
        align-items: center;
      }
      #user-email { font-weight: bold; }
  
      /* --- Menu Section --- */
      #menu-container { margin-top: 20px; }
      .menu-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 5px;
      }
      .menu-item span { font-weight: bold; }
      .menu-item button { 
        margin-left: 5px; 
        font-size: 1.2em;
        cursor: pointer;
      }
      .menu-item button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
  
    <h1>Bakery Menu</h1>
  
    <div id="auth-container">
      <p>Please sign in with your college email to vote.</p>
      <input type="email" id="email-input" placeholder="student@champlain.edu" />
      <button id="send-link-btn">Send Sign-In Link</button>
    </div>
    
    <div id="user-container">
      <p>Welcome, <span id="user-email"></span>!</p>
      <button id="sign-out-btn">Sign Out</button>
    </div>
  
    <div id="menu-container">
      <p>Please sign in to view the menu and vote.</p>
    </div>
  
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  
    <script>
      // =========================================================================
      // STEP 1: YOUR FIREBASE CONFIGURATION
      // =========================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyDZkVnHXI3siPKZXvFRPMEslbeoyTPGmJM",      // <-- (This is your key)
        authDomain: "ccidxbakery.firebaseapp.com",             // <-- (This is your domain)
        projectId: "ccidxbakery",                              // <-- (This is your project ID)
        storageBucket: "ccidxbakery.firebasestorage.app",
        messagingSenderId: "540177774922",
        appId: "1:540177774922:web:0db9487fb683f4edec29b3"
      };
  
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();
  
      // =========================================================================
      // STEP 2: YOUR APP'S JAVASCRIPT LOGIC
      // =========================================================================
      
      // --- Global Variables & DOM Elements ---
      let currentUser = null;
      const menuContainer = document.getElementById('menu-container');
      const authContainer = document.getElementById('auth-container');
      const userContainer = document.getElementById('user-container');
      const emailInput = document.getElementById('email-input');
      const sendLinkBtn = document.getElementById('send-link-btn');
      const userEmailSpan = document.getElementById('user-email');
      const signOutBtn = document.getElementById('sign-out-btn');
  
      // --- 1. Action Code Settings (Hard-coded URL) ---
      const actionCodeSettings = {
        url: 'https://q2computing.github.io/ccidxbakery/', 
        handleCodeInApp: true
      };
  
      // --- 2. Spam Cooldown Function ---
      function startButtonCooldown() {
        let secondsLeft = 60;
        sendLinkBtn.disabled = true;
        const timer = setInterval(() => {
          secondsLeft--;
          if (secondsLeft <= 0) {
            clearInterval(timer);
            sendLinkBtn.disabled = false;
            sendLinkBtn.textContent = 'Send Sign-In Link';
          } else {
            sendLinkBtn.textContent = `Wait ${secondsLeft}s`;
          }
        }, 1000);
      }
  
      // --- 3. Send Sign-In Link (with Domain Check) ---
      sendLinkBtn.onclick = async () => {
        const email = emailInput.value;
        
        const requiredDomain = '@champlain.edu'; 
        const testEmail = 'q2computing@gmail.com';
        
        if (!email.endsWith(requiredDomain) && email !== testEmail) {
          alert(`Please use a valid ${requiredDomain} email address.`);
          return;
        }
        
        try {
          startButtonCooldown();
          await auth.sendSignInLinkToEmail(email, actionCodeSettings);
          window.localStorage.setItem('emailForSignIn', email);
          alert('Sign-in link sent to ' + email + '. Check your inbox!');
          emailInput.value = '';
        } catch (error) {
          console.error("Error sending link:", error);
          alert("Error: " + error.message);
        }
      };
  
      // --- 4. Sign Out ---
      signOutBtn.onclick = async () => {
        try {
          await auth.signOut();
          alert("You have been signed out.");
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };
  
      // --- 5. Handle Magic Link Return ---
      async function handleMagicLinkSignIn() {
        if (auth.isSignInWithEmailLink(window.location.href)) {
          let email = window.localStorage.getItem('emailForSignIn');
          if (!email) {
            email = window.prompt('Please provide your email to complete sign-in');
          }
          
          try {
            const result = await auth.signInWithEmailLink(email, window.location.href);
            window.localStorage.removeItem('emailForSignIn');
            window.history.replaceState({}, document.title, window.location.pathname);
            console.log("Successfully signed in!", result.user);
          } catch (error) {
            console.error("Error signing in with link:", error);
            alert("Error: " + error.message);
          }
        }
      }
  
      // --- 6. Auth State Listener (The "Main" Function) ---
      auth.onAuthStateChanged((user) => {
        if (user) {
          // User is signed IN
          currentUser = user;
          authContainer.style.display = 'none';
          userContainer.style.display = 'flex'; // Use flex for alignment
          userEmailSpan.textContent = user.email;
          getMenu(); // Load the menu now that they're signed in
        } else {
          // User is signed OUT
          currentUser = null;
          authContainer.style.display = 'block';
          userContainer.style.display = 'none';
          menuContainer.innerHTML = '<p>Please sign in to view the menu and vote.</p>';
        }
      });
  
      // --- 7. Update Vote (with Double-Vote Prevention) ---
      async function updateVote(docId, newVote) {
        if (!currentUser) return;
  
        const userId = currentUser.uid;
        const voteRef = db.collection('user-votes').doc(userId);
        const menuDocRef = db.collection('weekly-menu').doc(docId);
        const increment = firebase.firestore.FieldValue.increment(1);
        const decrement = firebase.firestore.FieldValue.increment(-1);
  
        try {
          await db.runTransaction(async (transaction) => {
            const userVoteDoc = await transaction.get(voteRef);
            const menuDoc = await transaction.get(menuDocRef);
  
            if (!menuDoc.exists) {
              throw new Error("Menu item does not exist!");
            }
  
            const previousVote = userVoteDoc.exists ? userVoteDoc.data()[docId] : null;
  
            // Case 1: The user is voting the same way twice. Do nothing.
            if (previousVote === newVote) {
              console.log("Already voted this way.");
              return; // Stop the function
            }
  
            // Case 2: The user is changing their vote (e.g., 'like' to 'dislike')
            if (previousVote && previousVote !== newVote) {
              console.log(`Changing vote from ${previousVote} to ${newVote}`);
              
              // Create updates to swap the counts
              let updates = {};
              if (newVote === 'like') {
                updates = { likes: increment, dislikes: decrement }; // Add like, remove dislike
              } else {
                updates = { likes: decrement, dislikes: increment }; // Add dislike, remove like
              }
              transaction.update(menuDocRef, updates);
              
              // Update their personal vote record
              transaction.update(voteRef, { [docId]: newVote });
            }
            
            // Case 3: This is a brand new vote
            if (!previousVote) {
              console.log(`Recording new vote: ${newVote}`);
              
              // Increment the new vote count
              if (newVote === 'like') {
                transaction.update(menuDocRef, { likes: increment });
              } else {
                transaction.update(menuDocRef, { dislikes: increment });
              }
              
              // Record their personal vote
              transaction.set(voteRef, { [docId]: newVote }, { merge: true });
          }
        });

        console.log("Vote transaction successful!");
        getMenu(); // Refresh menu to show the new highlighted vote

      } catch (error) {
        console.error("Error updating vote:", error);
        alert(error.message);
      }
    }
  
      // --- 8. Get Menu (and Disable Voted Buttons) ---
      async function getMenu() {
        if (!currentUser) return;
  
        try {
          const userVoteRef = db.collection('user-votes').doc(currentUser.uid);
          const userVoteDoc = await userVoteRef.get();
          const userVotes = userVoteDoc.exists ? userVoteDoc.data() : {};
  
          const snapshot = await db.collection('weekly-menu').get();
          menuContainer.innerHTML = ''; 
  
          snapshot.forEach(doc => {
            const data = doc.data();
            const itemElement = document.createElement('div');
            itemElement.classList.add('menu-item');
            
            const itemText = document.createElement('span');
            itemText.textContent = `${data.itemName} (Likes: ${data.likes || 0})`;
            
            const buttonContainer = document.createElement('div');
            
            const likeButton = document.createElement('button');
            likeButton.textContent = 'ðŸ‘';
            likeButton.onclick = () => updateVote(doc.id, 'like');
  
            const dislikeButton = document.createElement('button');
            dislikeButton.textContent = 'ðŸ‘Ž';
            dislikeButton.onclick = () => updateVote(doc.id, 'dislike');
  
            if (userVotes[doc.id]) {
              // We no longer disable the buttons. We just style them.
              if (userVotes[doc.id] === 'like') {
                likeButton.style.border = '2px solid green';
                dislikeButton.style.border = 'none'; // Reset other button
              } else {
                dislikeButton.style.border = '2px solid red';
                likeButton.style.border = 'none'; // Reset other button
              }
            }
            
            buttonContainer.appendChild(likeButton);
            buttonContainer.appendChild(dislikeButton);
            itemElement.appendChild(itemText);
            itemElement.appendChild(buttonContainer);
            menuContainer.appendChild(itemElement);
          });
        } catch (error) {
          console.error("Error fetching menu:", error);
          menuContainer.innerHTML = '<p>Error loading menu.</p>';
        }
      }
  
      // --- 9. Initial Page Load ---
      handleMagicLinkSignIn();
  
    </script>
  </body>
</html>
